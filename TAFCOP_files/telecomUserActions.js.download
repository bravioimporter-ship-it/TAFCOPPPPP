/* 
   
    Author     : swarna
*/

// Wait for the document to fully load before attaching the event listener
document.addEventListener("DOMContentLoaded", function () {
  // Select the button element by its id
  
  var track = document.getElementById("btnReportStatus");
  // Add an event listener for the "click" event
  if(track!=null)
  track.addEventListener("click", function () {
    trackComplaint();
  });
  
  
  var reportButton = document.getElementById("reportButton");
  if(reportButton!=null)
  reportButton.addEventListener("click", function () {
    reportNumbers();
  });
  
  var session = document.getElementById("session_extend");
  if(session!=null)
  session.addEventListener("click", function(){
	  extendSession();
  });
  
  var from_submit = document.getElementById("submit_form");
  if(from_submit!=null)
  from_submit.addEventListener("click", function(){
	  formSubmit();
  });
  
  var mdal = document.getElementById("modal_Close");
  if(mdal!=null)
  mdal.addEventListener("click", function(){
	  modalClose();
  })
  
});


function formSubmit() {

		document.welcomePage.action="/telecomUser/logout";
    	//document.welcomePage.method="post";
    	document.welcomePage.submit();
		//document.getElementById("logoutForm").submit();
}





var timer2 = "3:01";
var extendSessionFlag=false;
var extendsessionSelect=false;
var interval = setInterval(function() {


  var timer = timer2.split(':');
  //by parsing integer, I avoid all extra string processing
  var minutes = parseInt(timer[0], 10);
  var seconds = parseInt(timer[1], 10);
  --seconds;
  minutes = (seconds < 0) ? --minutes : minutes;
  if (minutes < 0) clearInterval(interval);
  seconds = (seconds < 0) ? 59 : seconds;
  seconds = (seconds < 10) ? '0' + seconds : seconds;
  //minutes = (minutes < 10) ?  minutes : minutes;
  $('.countdown').html(minutes + ':' + seconds);
  timer2 = minutes + ':' + seconds;
}, 1000);



function extendSession() {
     //var token=document.getElementById('jwtToken').value;
	//root.appendChild('/sdr/getMessage2');
	// $('#loading').show();
	var csrfParameter = $("meta[name='_csrf_parameter']").attr("content");
	var csrfToken = $("meta[name='_csrf']").attr("content"); 
	var csrfHeader = $("meta[name='_csrf_header']").attr("content"); 
	var data = {};
	var headers = {};
	data[csrfParameter] = csrfToken;
	data["number"] = $("#number").val();
	//console.log("extend session");
	//console.log("${pageContext.request.userPrincipal.name}");
	headers[csrfHeader] = csrfToken;
	//headers["Authorization"] = "Bearer "+token;
	headers["Access-Control-Allow-Origin"] = "*"; 
	$.ajax({
		    url : "extendSession",
		    crossDomain: true,
		    type : 'GET',
		    headers: headers,    // THIS WAS ADDED
		   // data: data,
		    success : function(response) {
			// $('#loading').hide();
		      //alert("success");	
		      //timer2=timer2+"5:00";
		      if(response!="error"){
				extendSessionFlag=true;
		      var timer = timer2.split(':');
		      //by parsing integer, I avoid all extra string processing
		      var minutes = parseInt(timer[0], 10);
		      var seconds = parseInt(timer[1], 10);
		      minutes+=3;
		      timer2 = "3:00";
		      }
		      else {
			  swal("Error","Error occured! Cannot extend session! Please login again","error");
				}
		    },
		    error : function() {
			// $('#loading').hide();
		      swal("Error","Error occured! Cannot extend session!","error");
		    }
		  });
}


$(function () {
    var token = $("input[name='_csrf']").val();
    sessionStorage.setItem("token", token);
    var header = "X-CSRF-TOKEN";
    $(document).ajaxSend(function(e, xhr, options) {
        xhr.setRequestHeader(header, token);
    });
    //console.log("xhr sent");
 
      $('#loading').hide();
     // knowYourNumbers();
     
  
      
     $('.w3-hover-green').click(function(e){
   // $("#requiredInfoModal").modal('show');
   });
   
   
    $('.w3-hover-red').click(function(e){
   // $("#notRequiredInfoModal").modal('show');
   });
   
   $('.w3-hover-orange').click(function(e){
  
  // $("#notMyNumberInfoModal").modal('show');
   });
   
   
   var checkCloseX = 0;
        $(document).mousemove(function (e) {
            if (e.pageY <= 5) {
                checkCloseX = 1;
            }
            else { checkCloseX = 0; }
        });

        window.onbeforeunload = function (event) {
            if (event) {
                if (checkCloseX == 1) {

               			document.welcomePage.action="/telecomUser/logout";
		        	//document.welcomePage.method="post";
		        	/*document.welcomePage.action="/logout";*/
		        	document.welcomePage.submit();
                }
            }
        };
        
   
     
     		//function on check radio button (not my num/not required/required) on change and check if
     		//checkbox not selected then remove active class
     		$('input[type=radio]').change( function() {
				   //alert("test  "+ this.value);   
				   //alert(this.parentNode.parentNode.parentNode.parentNode);
				  			
				    var row=this.parentNode.parentNode.parentNode.parentNode;
				    var radioname=this.name;
				  //  $('input[name='+radioname+']').prop('checked', false);
				  if(  $(row).find('input[type=checkbox]:first').prop('checked')){
					  //if checkbox is selected then add class to row
					  var value=$(this).val();
					  //swal("value of radio selected="+value);
					 /* if(value=='not-my-number'){
						//add class red
						 $(row).css("background-color", "#f44336");
						//$(row).css("border", "1px solid #f44336");
						}
						else if(value=="not-required"){
							//add class orange
							 $(row).css("background-color", "#ff9800");
						//$(row).css("border", "1px solid #ff9800");
						}
						else
						{
							//add class green
						 $(row).css("background-color", "#4CAF50");
						//$(row).css("border", "1px solid #4CAF50");
							
						} */
				  }	
				  else
					  {
					  swal("Error!", "Please select number first!", "error");
					 // swal("");
					  $(this).parent().addClass('active').siblings().removeClass('active');
					  $('input[name='+radioname+']').prop('checked', false);
					  $(this).attr("checked", false);
					  $(this).removeAttr("checked");
					   $(this).removeClass('active');
					   
					   //added by Shahabuddin!!
					   // $(this).parent().css("background-color", "transparent");
					    // $(this).parent().css("color", "blue");
					   
					  return false;
					  }
				});
				
		
				
				
				//for each number selected via checkbox check if that number is already reported 
				//or not.
				  $('input[type=checkbox]').change(function() {
					 var row=this.parentNode.parentNode;
					 //console.log(row);
					//$(row).css("background-color", "");
       			 if($(this).is(":checked")) {
				 //$(row).css("background-color", "");
           		 var className = $(this).attr("class");
           		 var classArray = className.split(" ");
           		 var isupdateallowed=classArray[0];
           		 var selfnum=classArray[1]
           		 //console.log("isupdateallowed="+isupdateallowed);
           		 // console.log("selfnum="+selfnum);
           		 var compidReported=$(this).attr("name");
           		 var grpLen= $("#grpSize").val();
           		 
           		 if(selfnum=="true"){
					swal("You cannot report your own number!");
					$(this).attr("checked", false);
					$(this).prop('checked', false); 
					return false;
					}
           		 //alert(className);
           		 if(isupdateallowed==1){
							if(compidReported!=''){
								swal("This number has already been reported by you with Request id :"+compidReported +". Reporting it again will overwrite old request!");
							}
						}
						else
						{
							 if(selfnum=="true"){
					swal("You cannot report your own number!");
					$(this).attr("checked", false);
					$(this).prop('checked', false); 
					return false;
					}
					else{
							swal("You cannot report this number again! This number has been already reported with id :"+compidReported);
							$(this).attr("checked", false);
							$(this).prop('checked', false); 
							return false;
							
						}
						}
        		}
        		else
        		{
					//radio box not checked remove red/orange/green background
					// $(row).css("background-color", "");
					
					}
       			       
    			});
    			
    			
    			//remove active class from radio button on second click
					$('input[type="radio"]').click(function() {
					  const isActive = $(this).parent().hasClass('active');
					  console.log(isActive);
					  $(this).parent().siblings().removeClass('active');
					  if (!isActive) {
					    $(this).parent().addClass('active');
					  }
					});
    

$(document).keydown(function(event){
if(event.keyCode==123){
	return false;
}	
else if(event.keyCode==13){
	return false;
}

else if(event.ctrlKey && event.shiftKey && event.keyCode == 73){
	return false;
}
else if(event.ctrlKey && event.shiftKey && event.keyCode == 74){
	return false;
}
else if(event.ctrlKey && event.shiftKey && event.keyCode == 67){
	return false;
}
	
});

$(document).on("contextmenu", function(e){
	e.preventDefault();
});

    
    
});

 

	 
	   var idleTime = 0;
	    $(document).ready(function () {
	        // Increment the idle time counter every minute.
	        var idleInterval = setInterval(timerIncrement, 1000); // 1 minute

	        // Zero the idle timer on mouse movement.
	        $(this).mousemove(function (e) {
	            idleTime = 0;
	        });
	        $(this).keypress(function (e) {
	            idleTime = 0;
	        });
	    });



	    function timerIncrement() {
	        idleTime = idleTime + 1;
	        var timer = timer2.split(':');
		      //by parsing integer, I avoid all extra string processing
		      var minutes = parseInt(timer[0], 10);
		      var seconds = parseInt(timer[1], 10);
		      //console.log(minutes+":"+seconds);
		     if (minutes<=1 && seconds<=30 ) { // 20 seconds
		        	//console.log("going to log out");
		        	 //$("#myModal").modal();
		        	 if(!extendsessionSelect)
		        	 {
						 swal({
							 title: "Session going to expire!",
							 text: "Your session is going to expire soon.You may choose to extend session or logout!",
							 icon: "warning",
							 buttons: [
								 'No, cancel it!',
								 'Yes, Extend Session!'
							 ],
							 dangerMode: true,

						 })
							 .then((willDelete) => {
								 if (willDelete) {
									 extendSession();

								 } else {
									 swal("You pressed cancel!");
									 extendsessionSelect = true;
								 }
							 });	
				}

		        	//setInterval(blink_text, 1000);
		    		// alert("going to logout");
		        	//setTimeout(function() { alert('Going to log you out!'); }, 13000);
		        	
		        } 
		     
		     if (minutes<=0 && seconds<=20){
		        	document.welcomePage.action="/telecomUser/logout";
		        	//document.welcomePage.method="post";
		        	/*document.welcomePage.action="/logout";*/
		        	document.welcomePage.submit();
		        	}
		   
		     /*   if (idleTime > 3 && minutes<=1 && seconds>=30) { // 20 minutes
	        	console.log("going to log out");
	        	document.welcomePage.action="/PrivilegeManagement/logout";
	        	//document.welcomePage.method="post";
	        	document.welcomePage.submit();
	        } */
	    }

    	function blink_text() {
    	    $('.blink').fadeOut(500);
    	    $('.blink').fadeIn(500);
    	}
	    
	
	    
	    function openComplaints(){
	    	//var token=document.getElementById('jwtToken').value;
	    	   $('#loading').show();
	    	var csrfParameter = $("meta[name='_csrf_parameter']").attr("content");
	    	var csrfToken = $("meta[name='_csrf']").attr("content"); 
	    	var csrfHeader = $("meta[name='_csrf_header']").attr("content"); 
	    	var data = {};
	    	var headers = {};
	    	//data[csrfParameter] = csrfToken;
	    	var number= $("#number").val();  //$("#number").val();
	    	//data[csrfParameter] = csrfToken;
	    	//data["number"] = number;
	    	headers[csrfHeader] = csrfToken;
	    	//headers["Authorization"] = "Bearer "+token;
	    	//headers["Access-Control-Allow-Origin"] = "192.168.7.205"; 
	    	$.ajax({
	    		    url : "myComplaints",
	    		     crossDomain: true,
	    		    type : 'GET',
	    		    headers: headers,    // THIS WAS ADDED
	    		    //data: data,
	    		    success : function(response) {
	    		      //alert("success");	
	    		      //alert(response);
	    		      //alert(response);
	    		      //root.appendChild(response);
	    		    //  $('#myid').html(response);
	    		    if(response!="error"){
	    		     $('#loading').hide();
	    		  	$('#complaintsdiv').html(response);
	    		  	}
	    		  	else {
			 			$('#loading').hide();
	    		      swal("Error","Error Occured while fetching complaints!","error");
					}
	    		    },
	    		    error : function(response) {
	    		    	 $('#loading').hide();
	    		      swal("Error","Error Occured while fetching complaints!","error");
	    		    }
	    		  });
	    }
	    
	    
	    function reportNumbers(){
			//var table=$("#mynumbersTable");
			//var developerData = {};
			
			var array = new Array(); 
			let map = new Map();
			var table = document.getElementById("mynumbersTable");
			for (var i = 0, row; row = table.rows[i]; i++) {
			   //iterate through rows
			   //rows would be accessed using the "row" variable assigned in the for loop
			   
			   var divele=row.cells[2];
			  //console.log($(divele).find("input[type=radio]"));
			   var selradio= $(divele).find("input[type=radio]:checked").val();
			   //console.log("selected radio value="+selradio);
			   //console.log("input inside div="+divin);
			  var seqnum=row.cells[0].getElementsByTagName('input')[0].value;
			 // =row.cells[0].getElementsByTagName('input')[0].value;
			  var numcheck= $(row.cells[0]).find('input[type=checkbox]:first').prop('checked')
		
			 //console.log();
			 
			   var num=row.cells[1].innerHTML;
			   var developerData = {};
			   /*if ($(elementnotnumber).find('input').attr("type") == "radio")
				   {
	                if($(elementnotnumber).find('input').is(":checked")) */
	                if(numcheck && typeof selradio !== "undefined") 
	                	{developerData["seqNum"]=seqnum;
	                	developerData["maskedNumber"] =num;
	            	     developerData["reason"] =selradio; 		//"not-my-number";
	            	     array.push(developerData);
	                       	map.set(num, selradio); 
	                	}
	                	else
	                	{
							//console.log("radio not selected");
							}
			
			}
			
			if(array==''){
				 swal("Nothing to report!");
				return false;
			}
			
			
			  swal({
            title: "Are you sure?",
            text: "You can change options in your submitted requests before 11:59PM of same day only. No further changes will be allowed after that. Do you still want to proceed !",
            icon: "warning",
            buttons: true,
            dangerMode: true,
          })
          .then((willDelete) => {
            if (willDelete) {
		var csrfParameter = $("meta[name='_csrf_parameter']").attr("content");
			var csrfToken = $("meta[name='_csrf']").attr("content"); 
			var csrfHeader = $("meta[name='_csrf_header']").attr("content"); 
			
			var headers = {};
			var data={};
			//data[csrfParameter] = csrfToken;
			var number=$("#number").val();
			//data[csrfParameter] = csrfToken;
			//data["number"] = number;
			headers[csrfHeader] = csrfToken;
			try{
		
				
				$.ajax({
				    url : "report/reportNumbers",
				    //crossDomain: true,
				    type : 'POST',
				    headers: headers,    // THIS WAS ADDED
				    //data:data,
				    contentType : 'application/json; charset=utf-8',
				   
				    dataType : 'json',	
				    data: JSON.stringify(array),
				    success : function(response) {
				      //alert(response);	
				       $('#loading').hide();
				      var myJsonString = JSON.stringify(response);
				      //alert(myJsonString);
				   var str=""; var strerror="";
				      var len = response.length;
				         for(var i=0; i<len; i++){
			                var id = response[i].complaintNumbershort;
			                var reportednum = response[i].reportednumber
			                var compType=response[i].complaintType;
							var remarks=response[i].remarks;
							if(remarks == null){
								str += "<div align='justify'> <p> " +
			                    "Request id :"+ id +" generated for "+reportednum +" for : "+compType+" </p>";
							}else{
			                strerror+="\n"+
			                "Invalid Request for :"+reportednum+" for : "+compType;

			               }
			               // $("#userTable tbody").append(tr_str);
			            }
			            if(str!=""){
			            str+=" <p> Please save request id(s) for reference </p>";
			            str+="<p> The mobile connections reported as 'This is not my number' or 'Not Required' are flagged for re-verification by the service provider. Details"+
						" may be checked in FAQ section of <a href='https://www.sancharsaathi.gov.in/' target='_blank' style='color:blue;'>www.sancharsaathi.gov.in</a> </p> </div>";
			           //swal("Success",str,"success");
			        $("#requestInfoModal").find(".modal-body").html(str); 
			    
				    $("#requestInfoModal").modal();
				    $('#requestInfoModal').modal('show');
			           }
			           if(strerror!="")
			           {
						swal("Error!",strerror,"error");
						}
			         
			         const rows = document.querySelectorAll('table tr');
 						
 						rows.forEach((row) => {
							// $(row).css("background-color", "");
						});
			          
			           $('.btn-group').find('.btn-outline-primary').removeClass('active');
			           
					const checkboxes = document.querySelectorAll('table td input[type="checkbox"]');

						// Loop through the checkboxes and uncheck them
						checkboxes.forEach((checkbox) => {
							checkbox.checked = false;
						});
				  	
				    },
				    error : function(response) {
				    	 swal("Error!", "Error occured while generating request!", "error");
				    	 //alert("response  :"+response);
				      //alert("error  :"+e);
				    }
				  });
				
				
				
				
			
			}
			catch(err){
				 swal("Error!", "Error occured while generating request!", "error");
			}
	
	
           
            } else {
              swal("You pressed cancel!");
            }
        });	
				
			/*	
			var csrfParameter = $("meta[name='_csrf_parameter']").attr("content");
			var csrfToken = $("meta[name='_csrf']").attr("content"); 
			var csrfHeader = $("meta[name='_csrf_header']").attr("content"); 
			
			var headers = {};
			var data={};
			//data[csrfParameter] = csrfToken;
			var number=$("#number").val();
			//data[csrfParameter] = csrfToken;
			//data["number"] = number;
			headers[csrfHeader] = csrfToken;
			try{
		
				
				$.ajax({
				    url : "report/reportNumbers",
				    //crossDomain: true,
				    type : 'POST',
				    headers: headers,    // THIS WAS ADDED
				    //data:data,
				    contentType : 'application/json; charset=utf-8',
				   
				    dataType : 'json',	
				    data: JSON.stringify(array),
				    success : function(response) {
				      //alert(response);	
				       $('#loading').hide();
				      var myJsonString = JSON.stringify(response);
				      //alert(myJsonString);
				   var str="";
				      var len = response.length;
			            for(var i=0; i<len; i++){
			                var id = response[i].complaintNumbershort;
			                var reportednum = response[i].reportednumber
								
			                str += "\n " +
			                    "Request id :"+ id +" generated for "+reportednum;

			               // $("#userTable tbody").append(tr_str);
			            }
			            str+=" \n Please save request id(s) for reference ";
			           swal("Success",str,"success");
					const checkboxes = document.querySelectorAll('table td input[type="checkbox"]');

						// Loop through the checkboxes and uncheck them
						checkboxes.forEach((checkbox) => {
							checkbox.checked = false;
						});
				  	
				    },
				    error : function(response) {
				    	 swal("Error!", "Error occured while generating request!", "error");
				    	 //alert("response  :"+response);
				      //alert("error  :"+e);
				    }
				  });
				
				
				
				
			
			}
			catch(err){
				 swal("Error!", "Error occured while generating request!", "error");
			} */
		}
		
		function clearRadio(radioname){
			 $('input[name='+radioname+']').prop('checked', false);
		}
		
		function checkNumClicked(row){
			 var rowId = event.target.parentNode.parentNode.parentNode.id;
			// alert("radio clicked="+rowId);
			var numcheck=$(row).find('input[type=checkbox]:first').prop('checked');	
			//alert("Number selected :"+numcheck);
			
		}
		
		
		function trackComplaint(){
			var csrfParameter = $("meta[name='_csrf_parameter']").attr("content");
			var csrfToken = $("meta[name='_csrf']").attr("content"); 
			var csrfHeader = $("meta[name='_csrf_header']").attr("content"); 
			
			var headers = {};
			var data={};
			//data[csrfParameter] = csrfToken;
			var number=$("#number").val();
			var compId=$('#complaintID').val();
			if(compId==""){
				 swal("Error","Please enter request id first!","error");
				 return false;
			}
			//data[csrfParameter] = csrfToken;
			//data["number"] = ${pageContext.request.userPrincipal.name};
			data["compId"]=compId;
			headers[csrfHeader] = csrfToken;
			
			$.ajax({
			    url : "report/trackComplaint",
			    //crossDomain: true,
			    type : 'POST',
			    headers: headers,    // THIS WAS ADDED
			    //data:data,
			    
			    data: data,
			    success : function(response) {
			      //alert(response);	
			      var myJsonString = JSON.stringify(response);
			      //alert(myJsonString);
			   var str="";
			      var len = response.length;
			      
			      if(len==0){
				swal("No request found for Request id :"+compId);
					}
					else
					{
						str+="<table class='table table-striped'><thead><tr><th>Request Id</th>"+
						"<th>Reported Number</th><th>Request Type</th>"+
						"<th>Request Date</th> <th>Status</th></tr>";
						str+="<tbody>";
					 for(var i=0; i<len; i++){
						str+="<tr>"
		                var id = response[i].complaintNumbershort;
		                var reportedno=response[i].reportednumber;
		                var status=response[i].status;
		                var compType= response[i].complaintType;
		                var compDate=response[i].complaint_generation_date;
						str+="<td>"+id+"</td>";
						str+="<td>"+reportedno+"</td>";
						str+="<td>"+compType+"</td>";
						str+="<td>"+compDate+"</td>";
						str+="<td>"+status+"</td>";
		                str += "</tr>";

		               // $("#userTable tbody").append(tr_str);
		            }
		            str+="</tbody>";
		            str+=" </table>";
		            //alert(str);
			      $("#requestModal").find(".modal-body").html(str); 
			     // $("#exampleModal").find('.modal-title').text('New message ');
				     $("#requestModal").modal();
				     $('#requestModal').modal('show');
				    
			
			  	}
			    },
			    error : function(response) {
			    	
			    	 swal("Error","Error occured! Please logout and log-in again", "error");
			      //alert("error  :"+e);
			    }
			  });
			
		}
	
	
	function showNotMyNumberModal(){
		$("#notMyNumberInfoModal").modal('show');
	}
	
	function showNotRequiredModal(){
		$("#notRequiredInfoModal").modal('show');
	}
	
	function showRequiredModal(){
		$("#requiredInfoModal").modal('show');
	}
	